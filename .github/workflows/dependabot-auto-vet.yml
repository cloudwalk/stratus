name: Dependabot Cargo Vet

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches:
      - "*"
  workflow_dispatch:

jobs:
  vet-dependabot:
    if: github.actor == 'bronzelle-cw' || github.actor == 'dependabot[bot]'
    name: Vet Dependabot Updates
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    env:
      CARGO_VET_VERSION: 0.10.0

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: true

      - name: Set up Rust
        run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.88

      - name: Install cargo-vet
        run: cargo install cargo-vet

      - name: Initial cargo vet --locked
        id: vet_locked_initial
        continue-on-error: true
        run: |
          cargo vet --locked > vet-locked.log 2>&1 || true
          echo "status=$?" >> "$GITHUB_OUTPUT"

      - name: Try importing audits
        if: steps.vet_locked_initial.outputs.status != '0'
        run: |
          cargo vet > vet-import.log 2>&1 || true
          set +e
          cargo vet --locked > vet-locked-final.log 2>&1
          echo $? > vet-locked-final.status

      - name: Derive vet status
        id: vet_status
        run: |
          if [ -f vet-locked-final.status ]; then
            status="$(cat vet-locked-final.status)"
          else
            status="${{ steps.vet_locked_initial.outputs.status }}"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Early exit when fully vetted
        if: steps.vet_status.outputs.status == '0'
        run: echo "Vetting complete; no audits needed."

      - name: Collect unvetted dependency and crate diff
        id: collect_unvetted_and_diff
        if: steps.vet_status.outputs.status != '0'
        run: |
          # Expect a single unvetted crate from dependabot PRs; parse the line "crate:old -> new"
          logfile="vet-locked-final.log"
          if [ ! -f "$logfile" ]; then
            logfile="vet-locked.log"
          fi
          line="$(grep -m1 'unvetted dependencies:' -A2 "$logfile" | tail -n1 | tr -d '[:space:]')"
          crate="${line%%:*}"
          vers="${line#*:}"
          old="${vers%->*}"
          new="${vers#*->}"
          if [ -z "$crate" ] || [ -z "$old" ] || [ -z "$new" ]; then
            echo "Failed to parse unvetted crate/version from vet output" >&2
            exit 1
          fi
          cargo vet diff "$crate" "$old" "$new" --mode local --output-format=human > crate-diff.txt || true
          {
            echo "crate=$crate"
            echo "version=$new"
            echo "diff<<'EOF'"
            cat crate-diff.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          cp VETTING_CONTEXT.md vetting-context.md

      - name: Build prompt for Codex agent
        id: build_prompt
        if: steps.vet_status.outputs.status != '0'
        run: |
          ctx="$(cat vetting-context.md)"
          diff="${{ steps.collect_unvetted_and_diff.outputs.diff }}"
          crate="${{ steps.collect_unvetted_and_diff.outputs.crate }}"
          version="${{ steps.collect_unvetted_and_diff.outputs.version }}"
          {
            echo "prompt<<'EOF'"
            echo "You are a Rust supply-chain security auditor. Follow VETTING_CONTEXT strictly and emit an audit for the unvetted crate."
            echo
            echo "VETTING_CONTEXT:"
            echo "$ctx"
            echo
            echo "Unvetted dependency: $crate $version"
            echo
            echo "Diff between previous and bumped version (cargo vet diff):"
            echo "$diff"
            echo
            echo "Respond ONLY with JSON (no prose, no code fences) matching:"
            echo '[{\"crate\":\"name\",\"version\":\"x.y.z\",\"criteria\":\"safe-to-deploy\",\"who\":\"Agent Name <email>\",\"notes\":\"concise safety-focused notes per VETTING_CONTEXT\"}]'
            echo "If you cannot complete the audit, respond with an empty array: []"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ¤– Analyze and Fix Issue with Codex
        id: codex
        if: steps.vet_status.outputs.status != '0'
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-5-codex
          prompt: ${{ steps.build_prompt.outputs.prompt }}

      - name: Comment when agent step failed or missing
        if: steps.vet_status.outputs.status != '0' && (steps.codex.outcome == 'failure' || steps.codex.outputs.response == '')
        uses: actions/github-script@v7
        with:
          script: |
            const crate = '${{ steps.collect_unvetted_and_diff.outputs.crate }}';
            const version = '${{ steps.collect_unvetted_and_diff.outputs.version }}';
            const msg = [
              'Cargo vet still needs audits and no agent result was applied.',
              '',
              `Unvetted dependency: ${crate} ${version}`,
              '',
              'Codex agent was not configured or did not return a response. Ensure OPENAI_API_KEY is set and the prompt is valid.'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
            core.setFailed('Agent step failed or was not configured.')

      - name: Apply agent audits
        if: steps.vet_status.outputs.status != '0' && steps.codex.outcome == 'success' && steps.codex.outputs.response != ''
        run: |
          set -eo pipefail
          echo '${{ steps.codex.outputs.response }}' > agent-audits.json
          audits="$(cat agent-audits.json)"
          echo "Agent audits: $audits"
          jq -c '.[]' agent-audits.json | while read -r row; do
            crate="$(echo "$row" | jq -r '.crate')"
            version="$(echo "$row" | jq -r '.version')"
            criteria="$(echo "$row" | jq -r '.criteria')"
            who="$(echo "$row" | jq -r '.who')"
            notes="$(echo "$row" | jq -r '.notes')"
            if [ -z "$crate" ] || [ -z "$version" ] || [ -z "$criteria" ] || [ -z "$who" ]; then
              echo "Incomplete audit entry: $row" >&2
              exit 1
            fi
            cargo vet certify "$crate" "$version" --criteria "$criteria" --who "$who" --notes "$notes" --accept-all
            echo "$who" > .agent-who
          done

      - name: Verify cargo vet after agent audits
        if: steps.vet_status.outputs.status != '0' && steps.codex.outcome == 'success' && steps.codex.outputs.response != ''
        run: cargo vet --locked

      - name: Commit audit changes
        if: steps.vet_status.outputs.status != '0' && steps.codex.outcome == 'success' && steps.codex.outputs.response != ''
        run: |
          set -eo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          who="$(cat .agent-who || true)"
          git config user.name "${who:-dependabot-vet-bot}"
          git config user.email "actions@github.com"
          git add supply-chain/audits.toml supply-chain/imports.lock || true
          git commit -m "chore(vet): apply agent audits"
          git push origin "HEAD:${{ github.event.pull_request.head.ref }}"
